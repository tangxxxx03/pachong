import time
import hmac
import hashlib
import base64
import urllib.parse
import requests
import os

# 从环境变量里拿 webhook 和 secret
WEBHOOK = os.getenv("DINGTALK_WEBHOOKHR")
SECRET = os.getenv("DINGTALK_SECRET_HR")

def send_dingtalk_msg(content: str):
    timestamp = str(round(time.time() * 1000))  # 毫秒级时间戳
    secret_enc = SECRET.encode('utf-8')
    string_to_sign = '{}\n{}'.format(timestamp, SECRET).encode('utf-8')
    hmac_code = hmac.new(secret_enc, string_to_sign, digestmod=hashlib.sha256).digest()
    sign = urllib.parse.quote_plus(base64.b64encode(hmac_code))

    url = f"{WEBHOOK}&timestamp={timestamp}&sign={sign}"

    headers = {"Content-Type": "application/json"}
    data = {
        "msgtype": "text",
        "text": {"content": content}
    }
    resp = requests.post(url, json=data, headers=headers)
    print("钉钉返回:", resp.text)

# 示例调用
if __name__ == "__main__":
    send_dingtalk_msg("测试：这是带加签的钉钉推送 ✅")
