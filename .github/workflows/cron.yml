name: run-pachong

on:
  schedule:
    # âœ… æ­£å¼ï¼šå·¥ä½œæ—¥ åŒ—äº¬æ—¶é—´ 08:30 è¿è¡Œï¼ˆUTC 00:30ï¼‰
    - cron: "30 0 * * 1-5"
    # â›³ï¸ å¦‚æœè¿˜è¦æµ‹è¯•æ¯ 15 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼Œæ”¹ä¸ºä¸‹é¢è¿™ä¸€è¡Œï¼ˆäºŒé€‰ä¸€ï¼‰
    # - cron: "*/15 * * * 1-5"
  workflow_dispatch: {}   # ä¿ç•™æ‰‹åŠ¨æŒ‰é’®åšè°ƒè¯•

# é˜²æ­¢ä½ è¿ç»­ç‚¹å¤šæ¬¡æˆ–åŒæ—¶é—´é‡å¤è§¦å‘é€ æˆå¹¶å‘é‡å¤
concurrency:
  group: pachong-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # å®‰è£… Chromeï¼ˆSelenium éœ€è¦æµè§ˆå™¨ï¼‰
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # æœ‰ requirements.txt å°±æŒ‰å®ƒè£…ï¼›æ²¡æœ‰ä¹Ÿä¸æŠ¥é”™
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # å…œåº•ï¼šä¿è¯ selenium / webdriver-manager ç­‰å…³é”®åŒ…å­˜åœ¨
          pip install -q --upgrade selenium webdriver-manager requests beautifulsoup4 lxml

      # å¯é€‰ï¼šè‡ªæ£€ä¸€ä¸‹ Secrets æ˜¯å¦å­˜åœ¨ï¼ˆä¸è¾“å‡ºå…·ä½“å€¼ï¼‰
      - name: Check DingTalk secrets (no leak)
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}     # å¼€å¯â€œåŠ ç­¾â€æ‰éœ€è¦
          DINGTALK_KEYWORD: ${{ secrets.DINGTALK_KEYWORD }}   # å¼€å¯â€œå…³é”®å­—â€æ‰éœ€è¦
        run: |
          python - <<'PY'
          import os
          for k in ("DINGTALK_WEBHOOK","DINGTALK_SECRET","DINGTALK_KEYWORD"):
              v = os.getenv(k, "")
              print(f"{k}: {'OK' if v else 'MISSING'} (len={len(v)})")
          PY

      # âœ… åªæœ‰ scheduleï¼ˆå®šæ—¶ï¼‰æ—¶æ‰çœŸæ­£å‘é€
      - name: Run pachong (send)
        if: github.event_name == 'schedule'
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}     # è‹¥æœºå™¨äººå¼€å¯â€œåŠ ç­¾â€
          DINGTALK_KEYWORD: ${{ secrets.DINGTALK_KEYWORD }}   # è‹¥æœºå™¨äººå¼€å¯â€œå…³é”®å­—â€
          HEADLESS: "1"
        run: |
          python main.py

      # ğŸ” æ‰‹åŠ¨/è°ƒè¯•æ—¶åªè·‘ã€ä¸å‘ï¼ˆè‹¥ä¸éœ€è¦è°ƒè¯•å¯åˆ æ‰è¿™ä¸€æ­¥ï¼‰
      - name: Run pachong (dry-run)
        if: github.event_name != 'schedule'
        env:
          HEADLESS: "1"
        run: |
          # å¦‚æœ main.py æ—  --dry-runï¼Œå¯ä»¥åœ¨è„šæœ¬é‡Œç”¨ç¯å¢ƒå˜é‡æ§åˆ¶â€œä¸å‘é€â€
          export DRY_RUN=1
          python main.py || true
