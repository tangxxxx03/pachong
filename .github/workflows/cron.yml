name: run-pachong

on:
  schedule:
    # 工作日 8:30（UTC=00:30）
    - cron: "30 0 * * 1-5"
  workflow_dispatch:
    inputs:
      send:
        description: "手动触发是否发送到钉钉？"
        type: choice
        required: true
        default: "no"
        options: ["no", "yes"]

concurrency:
  group: pachong-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check DingTalk secrets (no leak)
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}   # 招投标用这个 webhook（无加签就只填这个）
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}    # 开了加签才需要，没开就别配
          DINGTALK_KEYWORD: ${{ secrets.DINGTALK_KEYWORD }}   # 没启关键字也可以不配
        run: |
          python - <<'PY'
          import os
          for k in ("DINGTALK_WEBHOOK","DINGTALK_SECRET","DINGTALK_KEYWORD"):
              v = os.getenv(k, "")
              print(f"{k}: {'OK' if v else 'MISSING'} (len={len(v)})")
          PY

      # ✅ 满足：定时触发 或 手动触发且选择了 yes 才真正发送
      - name: Run pachong (send)
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.send == 'yes')
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}
          DINGTALK_KEYWORD: ${{ secrets.DINGTALK_KEYWORD }}
        run: |
          python main.py

      # 🔎 其他情况（手动但选择 no、或 push）只跑不发，方便看日志
      - name: Run pachong (dry-run)
        if: github.event_name != 'schedule' && !(github.event_name == 'workflow_dispatch' && inputs.send == 'yes')
        env:
          DRY_RUN: "1"
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}
        run: |
          python main.py || true
