name: run-pachong

on:
  schedule:
    # å·¥ä½œæ—¥ 8:30ï¼ˆUTC=00:30ï¼‰
    - cron: "30 0 * * 1-5"
  workflow_dispatch:
    inputs:
      send:
        description: "æ‰‹åŠ¨è§¦å‘æ˜¯å¦å‘é€åˆ°é’‰é’‰ï¼Ÿ"
        type: choice
        required: true
        default: "no"
        options: ["no", "yes"]

concurrency:
  group: pachong-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check DingTalk secrets (no leak)
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}   # æ‹›æŠ•æ ‡ç”¨è¿™ä¸ª webhookï¼ˆæ— åŠ ç­¾å°±åªå¡«è¿™ä¸ªï¼‰
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}    # å¼€äº†åŠ ç­¾æ‰éœ€è¦ï¼Œæ²¡å¼€å°±åˆ«é…
          DINGTALK_KEYWORD: ${{ secrets.DINGTALK_KEYWORD }}   # æ²¡å¯å…³é”®å­—ä¹Ÿå¯ä»¥ä¸é…
        run: |
          python - <<'PY'
          import os
          for k in ("DINGTALK_WEBHOOK","DINGTALK_SECRET","DINGTALK_KEYWORD"):
              v = os.getenv(k, "")
              print(f"{k}: {'OK' if v else 'MISSING'} (len={len(v)})")
          PY

      # âœ… æ»¡è¶³ï¼šå®šæ—¶è§¦å‘ æˆ– æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† yes æ‰çœŸæ­£å‘é€
      - name: Run pachong (send)
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.send == 'yes')
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}
          DINGTALK_KEYWORD: ${{ secrets.DINGTALK_KEYWORD }}
        run: |
          python main.py

      # ğŸ” å…¶ä»–æƒ…å†µï¼ˆæ‰‹åŠ¨ä½†é€‰æ‹© noã€æˆ– pushï¼‰åªè·‘ä¸å‘ï¼Œæ–¹ä¾¿çœ‹æ—¥å¿—
      - name: Run pachong (dry-run)
        if: github.event_name != 'schedule' && !(github.event_name == 'workflow_dispatch' && inputs.send == 'yes')
        env:
          DRY_RUN: "1"
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}
        run: |
          python main.py || true
