name: "HR News (Auto Cron Runner)"

on:
  workflow_dispatch:
  schedule:
    # 每天北京时间 09:00（= UTC 01:00）
    - cron: "0 1 * * *"

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. 拉取仓库代码
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 设置 Python 环境
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. 安装依赖（requirements.txt + pandas）
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pandas || true

      # 4. 运行主脚本 main.py（根目录）
      - name: Run HR News crawler
        env:
          AUTO_RANGE: "true"
          PAGES: "3"
          LIMIT: "60"
          DELAY: "0.8"
          # ✅ 使用固定钉钉 Webhook
          DINGTALK_WEBHOOKA: "https://oapi.dingtalk.com/robot/send?access_token=6e945607bb71c2fd9bb3399c6424fa7dece4b9798d2a8ff74b0b71ab47c9d182"
          DINGTALK_SECRETA: ""
          NO_PUSH: "false"
        run: |
          # 清理代理变量防止推送失败
          unset http_proxy https_proxy all_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY NO_PROXY
          set -e

          echo "[Info] Python: $(python --version)"
          echo "[Info] Current UTC time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "[Info] Target push time: 09:00 (Asia/Shanghai)"

          CMD="python main.py --pages \"${PAGES}\" --delay \"${DELAY}\" --limit \"${LIMIT}\""
          if [ "${AUTO_RANGE}" = "true" ]; then
            CMD="${CMD} --auto-range"
          else
            CMD="${CMD} --window-hours \"${WINDOW_HOURS:-48}\""
          fi
          if [ "${NO_PUSH}" = "true" ]; then
            CMD="${CMD} --no-push"
          fi

          echo "[Run] ${CMD}"
          eval ${CMD} | tee hr_news.log

      # 5. 上传日志与结果
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hr-news-results
          path: |
            hr_news.log
            hr_news.md
          if-no-files-found: ignore
