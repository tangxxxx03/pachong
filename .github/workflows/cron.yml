name: run-pachong

on:
  schedule:
    # å·¥ä½œæ—¥ åŒ—äº¬æ—¶é—´ 08:30 è¿è¡Œï¼ˆUTC 00:30ï¼‰
    - cron: "30 0 * * 1-5"
  workflow_dispatch: {}   # ä¿ç•™æ‰‹åŠ¨è°ƒè¯•

concurrency:
  group: pachong-${{ github.ref }}
  cancel-in-progress: true   # é˜²æ­¢å¹¶å‘é‡å¤è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests beautifulsoup4 lxml selenium webdriver-manager

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Check DingTalk secrets (no leak)
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}
          DINGTALK_KEYWORD: ${{ secrets.DINGTALK_KEYWORD }}
        run: |
          python - <<'PY'
          import os
          for k in ("DINGTALK_WEBHOOK","DINGTALK_SECRET","DINGTALK_KEYWORD"):
              v = os.getenv(k, "")
              print(f"{k}: {'OK' if v else 'MISSING'} (len={len(v)})")
          PY

      # âœ… å®šæ—¶ä»»åŠ¡æ—¶ï¼ŒçœŸæ­£æ‰§è¡Œå¹¶æ¨é€åˆ°é’‰é’‰
      - name: Run pachong (send)
        if: github.event_name == 'schedule'
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET:  ${{ secrets.DINGTALK_SECRET }}
          DINGTALK_KEYWORD: ${{ secrets.DINGTALK_KEYWORD }}
        run: |
          python main.py

      # ğŸ” æ‰‹åŠ¨ / push æ—¶åªè¿è¡Œä½†ä¸å‘æ¶ˆæ¯
      - name: Run pachong (dry-run)
        if: github.event_name != 'schedule'
        env:
          DRY_RUN: "1"
        run: |
          python main.py || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pachong-output
          path: |
            pachong_*.csv
            pachong_*.json
