# -*- coding: utf-8 -*-
"""
ä¸€è´¢æ—©æŠ¥ Â· ä»Šæ—¥æ ‡é¢˜é€Ÿè§ˆï¼ˆåªæŠ“æ ‡é¢˜ï¼Œä¸æŠ“æ­£æ–‡ï¼‰

è§„åˆ™ï¼š
1. ä»…æŠ“å–â€œä»Šå¤©â€çš„ RSS æ¡ç›®
2. åªå‘é€æ ‡é¢˜ + é“¾æ¥
3. ä¸è§£ææ­£æ–‡ã€ä¸åˆ†æ ç›®
4. è‹¥ä»Šå¤©æ— æ–°æ¡ç›® â†’ å®‰é™é€€å‡º
"""

import os
import time
import hmac
import json
import base64
import hashlib
import urllib.parse
from datetime import datetime, timezone
import requests
import feedparser

# ========== é…ç½® ==========
RSS_URLS = [
    "https://rsshub.app/yicai/feed/669",
    "https://rsshub.rssforever.com/yicai/feed/669",
]

FETCH_TIMEOUT = 20
UA = "Mozilla/5.0"

TOP_N = 10

# ========== é’‰é’‰ ==========
def dingtalk_sign(timestamp, secret):
    string_to_sign = f"{timestamp}\n{secret}"
    hmac_code = hmac.new(
        secret.encode("utf-8"),
        string_to_sign.encode("utf-8"),
        digestmod=hashlib.sha256
    ).digest()
    return urllib.parse.quote_plus(base64.b64encode(hmac_code))

def send_dingtalk(markdown):
    webhook = os.getenv("DINGTALK_WEBHOOK")
    secret = os.getenv("DINGTALK_SECRET")

    if not webhook:
        raise RuntimeError("ç¼ºå°‘ DINGTALK_WEBHOOK")

    url = webhook
    if secret:
        ts = str(int(time.time() * 1000))
        sign = dingtalk_sign(ts, secret)
        url += f"&timestamp={ts}&sign={sign}"

    payload = {
        "msgtype": "markdown",
        "markdown": {
            "title": "ä¸€è´¢æ—©æŠ¥ Â· ä»Šæ—¥æ ‡é¢˜",
            "text": markdown
        }
    }

    r = requests.post(url, json=payload, timeout=FETCH_TIMEOUT)
    r.raise_for_status()

# ========== æ ¸å¿ƒé€»è¾‘ ==========
def is_today(entry):
    """
    RSS æ—¶é—´ â†’ åªä¿ç•™ä»Šå¤©ï¼ˆä»¥åŒ—äº¬æ—¶é—´ï¼‰
    """
    if not hasattr(entry, "published_parsed") or not entry.published_parsed:
        return False

    published = datetime.fromtimestamp(
        time.mktime(entry.published_parsed),
        tz=timezone.utc
    ).astimezone(timezone.utc)

    today = datetime.now(timezone.utc).date()
    return published.date() == today

def fetch_today_titles():
    for url in RSS_URLS:
        try:
            r = requests.get(url, headers={"User-Agent": UA}, timeout=FETCH_TIMEOUT)
            r.raise_for_status()
            feed = feedparser.parse(r.content)

            items = []
            for e in feed.entries:
                if is_today(e):
                    items.append({
                        "title": e.title.strip(),
                        "link": e.link.strip()
                    })

            if items:
                return items[:TOP_N]

        except Exception as e:
            print(f"[RSS] fail via {url}: {e}")

    return []

def main():
    items = fetch_today_titles()

    if not items:
        print("ä»Šå¤©æ²¡æœ‰æ–°çš„ä¸€è´¢æ—©æŠ¥æ ‡é¢˜ï¼Œè·³è¿‡æ¨é€ã€‚")
        return

    today = datetime.now().strftime("%Y-%m-%d")
    lines = [f"### ğŸ“° ä¸€è´¢æ—©æŠ¥ Â· {today}ï¼ˆä»…æ ‡é¢˜ï¼‰", ""]

    for i, it in enumerate(items, 1):
        lines.append(f"{i}. [{it['title']}]({it['link']})")

    send_dingtalk("\n".join(lines))
    print(f"å·²æ¨é€ {len(items)} æ¡æ ‡é¢˜ã€‚")

if __name__ == "__main__":
    main()
